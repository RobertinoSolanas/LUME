<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LUME â€“ Bike Nav (Smart Cache)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin />
  <style>
    :root { --accent:#1abc9c; --bg:#fff; --radius:.75rem; --shadow:0 2px 6px rgba(0,0,0,.15);}  
    html,body{margin:0;height:100%;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:#f5f7f8;}
    #map{height:100%;width:100%;}
    #controls{position:absolute;top:10px;left:10px;z-index:1000;background:var(--bg);padding:.75rem 1rem;border-radius:var(--radius);box-shadow:var(--shadow);display:grid;gap:.4rem;grid-template-columns:1fr 1fr auto auto;width:480px;align-items:center;}
    #info{position:absolute;top:10px;right:10px;z-index:1000;background:var(--bg);padding:.75rem 1rem;border-radius:var(--radius);box-shadow:var(--shadow);width:340px;max-height:90%;overflow:auto;}
    input[type=text]{padding:.35rem .6rem;border:1px solid #ccc;border-radius:var(--radius);font-size:.9rem;}
    button{background:var(--accent);color:#fff;border:none;padding:.45rem .75rem;border-radius:var(--radius);font-size:.9rem;cursor:pointer;transition:opacity .2s;}
    button:disabled{opacity:.4;cursor:not-allowed;}button:hover:not(:disabled){opacity:.85;}
    .bikeIcon{font-size:30px;line-height:30px;}
  </style>
</head>
<body>
  <form id="controls" onsubmit="return false;">
    <input id="start" placeholder="Start (addr or lat,lon)" />
    <input id="end" placeholder="Destination (addr or lat,lon)" />
    <button id="routeBtn">Route</button>
    <button id="goBtn" disabled>Go</button>
  </form>

  <aside id="info">
    <h3>Route information</h3>
    <p id="distInfo">Distance: â€“</p>
    <button id="playRouteBtn" aria-label="Speak route">ðŸ”Š</button>
    <ul id="routeSteps"></ul>
  </aside>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
  <script>
    /* ------ Map ------ */
    const map=L.map('map',{keyboard:true}).setView([51.1657,10.4515],6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OpenStreetMap contributors',maxZoom:19}).addTo(map);

    /* ------ Elements ------ */
    const sIn=document.getElementById('start'), eIn=document.getElementById('end');
    const routeBtn=document.getElementById('routeBtn'), goBtn=document.getElementById('goBtn');
    const stepsUL=document.getElementById('routeSteps'), playBtn=document.getElementById('playRouteBtn');
    const distInfo=document.getElementById('distInfo');

    /* ------ Speech ------ */
    let routeSpeech='';
    function speak(txt){if(!('speechSynthesis'in window))return;window.speechSynthesis.cancel();const u=new SpeechSynthesisUtterance(txt);u.lang='de-DE';window.speechSynthesis.speak(u);}  playBtn.onclick=()=>routeSpeech&&speak(routeSpeech);

    /* ------ Helpers ------ */
    async function geocode(q){const u='https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&countrycodes=de&limit=1&q='+encodeURIComponent(q);const r=await fetch(u,{headers:{Referer:'file://'}});return r.json();}
    async function fetchRoute(sl,so,el,eo){const u=`https://router.project-osrm.org/route/v1/cycling/${so},${sl};${eo},${el}?overview=full&geometries=geojson&steps=true`;const r=await fetch(u);if(!r.ok)throw new Error('route');return r.json();}
    const toC=async v=>/^(-?\d+\.\d+),(-?\d+\.\d+)$/.test(v)?{lat:+v.split(',')[0],lon:+v.split(',')[1]}:(await geocode(v))[0]&&{lat:+(await geocode(v))[0].lat,lon:+(await geocode(v))[0].lon};
    const interp=(a,b,t)=>a+(b-a)*t;
    const sumDist=arr=>arr.reduce((acc,_,i)=>i?acc+arr[i-1].distanceTo(arr[i]):0,0);

    /* ------ POI Cache (20 km windows) ------ */
    const bucketCache={};
    function bucketKey(lat,lon){return lat.toFixed(4)+','+lon.toFixed(4);} // coarse ~11m grid
    async function fetchPOI(lat,lon){const key=bucketKey(lat,lon);if(key in bucketCache)return bucketCache[key];const q=`[out:json][timeout:15];(node(around:250,${lat},${lon})["name"];way(around:250,${lat},${lon})["name"];);out center 1;`;try{const r=await fetch('https://overpass-api.de/api/interpreter?data='+encodeURIComponent(q));if(!r.ok)throw'';const d=await r.json();return bucketCache[key]=d.elements[0]?.tags?.name||null;}catch{return bucketCache[key]=null;}}

    // Pre-cache aheadDistance meters from startIdx along latlngs
    function preCacheAhead(startIdx, aheadMeters){let accum=0;for(let i=startIdx;i<latlngs.length-1 && accum<aheadMeters;i++){const a=latlngs[i],b=latlngs[i+1];const seg=a.distanceTo(b);accum+=seg;fetchPOI((a.lat+b.lat)/2,(a.lng+b.lng)/2);} }

    /* ------ State ------ */
    let latlngs=[], total=0;
    let markerStart, markerEnd, line, nav;

    /* ------ Route button ------ */
    routeBtn.onclick=async()=>{
      const sv=sIn.value.trim(),ev=eIn.value.trim();if(!sv||!ev){alert('Enter start & destination');return;}
      try{const s=await toC(sv), t=await toC(ev);markerStart&&map.removeLayer(markerStart);markerEnd&&map.removeLayer(markerEnd);markerStart=L.marker([s.lat,s.lon]).addTo(map);markerEnd=L.marker([t.lat,t.lon]).addTo(map);const data=await fetchRoute(s.lat,s.lon,t.lat,t.lon);latlngs=data.routes[0].geometry.coordinates.map(c=>L.latLng(c[1],c[0]));line&&map.removeLayer(line);line=L.polyline(latlngs,{color:'#FF5722',weight:4}).addTo(map);map.fitBounds(line.getBounds(),{padding:[30,30]});total=sumDist(latlngs);distInfo.textContent=`Distance: ${(total/1000).toFixed(1)} km | left: ${(total/1000).toFixed(1)} km`;stepsUL.innerHTML='';routeSpeech='';data.routes[0].legs[0].steps.forEach((st,i)=>{const li=document.createElement('li');li.textContent=st.maneuver.instruction||'Continue';stepsUL.appendChild(li);routeSpeech+=`${i+1}. ${li.textContent}. `;});goBtn.disabled=false;speak('Route ready. Press Go to start.');}
      catch(e){console.warn(e);alert('Route failed');}}

    /* ------ Go button ------ */
    goBtn.onclick=()=>{
      if(latlngs.length<2)return;goBtn.disabled=true;
      // Happy face pause 1.5s
      nav&&map.removeLayer(nav);
      nav=L.marker(latlngs[0],{icon:L.divIcon({className:'bikeIcon',html:'ðŸ˜ƒ',iconSize:[30,30]})}).addTo(map);
      speak('Los gehtâ€™s!');
      preCacheAhead(0,50000); // initial 50 km cache
      setTimeout(()=>{
        // switch to bike icon & start animation
        nav.setIcon(L.divIcon({className:'bikeIcon',html:'ðŸš²',iconSize:[30,30]}));
        animateRide();
      },1500);
    };

    /* ------ Ride animation function ------ */
    function animateRide(){
      const speed=13.9; // 50 km/h
      let idx=0,segS=latlngs[0],segE=latlngs[1],segD=segS.distanceTo(segE),segT=segD/speed,segTS=null;
      let travelled=0,lastPOIAnn=0,lastCacheTrigger=0,lastUpdate=0;
      function raf(ts){if(!segTS)segTS=ts;let prog=(ts-segTS)/1000/segT;while(prog>=1&&idx<latlngs.length-2){travelled+=segD;idx++;segS=latlngs[idx];segE=latlngs[idx+1];segD=segS.distanceTo(segE);segT=segD/speed;segTS+=segT*1000;prog=(ts-segTS)/1000/segT;}if(idx>=latlngs.length-1){nav.setLatLng(latlngs.at(-1));map.panTo(latlngs.at(-1));speak('You have arrived at your destination.');distInfo.textContent=`Distance: ${(total/1000).toFixed(1)} km | left: 0 km`;goBtn.disabled=false;return;}prog=Math.min(Math.max(prog,0),1);const lat=interp(segS.lat,segE.lat,prog),lon=interp(segS.lng,segE.lng,prog);nav.setLatLng([lat,lon]);map.panTo([lat,lon],{animate:false});const now=travelled+segD*prog; // metres
        // distance panel every 5s
        if(ts-lastUpdate>5000){lastUpdate=ts;const left=total-now;distInfo.textContent=`Distance: ${(total/1000).toFixed(1)} km | left: ${(left/1000).toFixed(1)} km`;}
        // POI voice each 10 km bucket
        const kmBucket=Math.floor(now/10000);if(kmBucket>lastPOIAnn){lastPOIAnn=kmBucket;fetchPOI(lat,lon).then(n=>{if(n)speak(`In der NÃ¤he: ${n}`);});}
        // Cache ahead: every 20 km progress cache next 20 km
        if(now-lastCacheTrigger>20000){lastCacheTrigger+=20000;preCacheAhead(idx,20000);}requestAnimationFrame(raf);}requestAnimationFrame(raf);}  </script>
  <script src="lume-voice.js"></script>
</body>
</html>