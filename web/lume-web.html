<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LUME â€“ Germany OSM + Routing</title>
    <!-- Leaflet -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      crossorigin=""
    />
    <style>
      :root {
        --accent: #1abc9c;
        --bg: #ffffff;
        --radius: 0.75rem;
        --shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      }
      html,
      body {
        margin: 0;
        height: 100%;
        font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial,
          sans-serif;
        background: #f5f7f8;
      }
      #map {
        height: 100%;
        width: 100%;
      }
      #controls,
      #info {
        position: absolute;
        top: 10px;
        z-index: 1000;
        background: var(--bg);
        padding: 0.75rem 1rem;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
      }
      #controls {
        left: 10px;
        display: grid;
        gap: 0.4rem;
        grid-template-columns: 1fr 1fr auto;
        width: 420px;
      }
      #info {
        right: 10px;
        width: 320px;
        max-height: 90%;
        overflow: auto;
      }
      input[type="text"] {
        padding: 0.35rem 0.6rem;
        border: 1px solid #ccc;
        border-radius: var(--radius);
        font-size: 0.9rem;
      }
      button {
        background: var(--accent);
        color: #fff;
        border: none;
        padding: 0.45rem 0.7rem;
        border-radius: var(--radius);
        font-size: 0.9rem;
        cursor: pointer;
        transition: opacity 0.2s;
      }
      button:hover {
        opacity: 0.85;
      }
      h4 {
        margin: 0.5rem 0 0.3rem;
      }
      ul {
        margin: 0;
        padding-left: 1rem;
      }
      li {
        margin-bottom: 0.3rem;
        font-size: 0.85rem;
      }
      #routeSteps li {
        list-style: decimal;
      }
      #poiList button,
      #routeSteps button {
        background: none;
        border: none;
        font: inherit;
        text-align: left;
        color: inherit;
        cursor: pointer;
      }
      #poiList button:hover,
      #routeSteps button:hover {
        color: var(--accent);
        text-decoration: underline;
      }
      #playRouteBtn {
        background: none;
        color: var(--accent);
        font-size: 1.1rem;
        padding: 0 0.2rem;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <!-- Controls -->
    <form id="controls" aria-label="Routing search" onsubmit="return false;">
      <input id="start" type="text" placeholder="Start" />
      <input id="end" type="text" placeholder="Destination" />
      <button id="routeBtn">Route</button>
    </form>

    <!-- Sidebar -->
    <aside id="info">
      <h3>Information</h3>
      <p id="coords">Select or search positionsâ€¦</p>

      <!-- POIs -->
      <div id="poiBox">
        <h4>POIs nearby</h4>
        <ul id="poiList"></ul>
      </div>

      <!-- Wikipedia description -->
      <div id="descBox" style="display:none">
        <button id="speakBtn" aria-label="Speak description">ðŸ”Š</button>
        <strong>Description</strong>
        <p id="description"></p>
      </div>

      <!-- Routing steps -->
      <div id="routeBox" style="display:none; border-top:1px solid #eee; margin-top:0.6rem; padding-top:0.4rem;">
        <button id="playRouteBtn" aria-label="Speak route">ðŸ”Š</button>
        <strong>Route instructions</strong>
        <ul id="routeSteps"></ul>
      </div>
    </aside>

    <!-- Map -->
    <div id="map" aria-label="Map of Germany"></div>

    <!-- Libraries -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <!-- Main script -->
    <script>
      const map = L.map("map", { keyboard: true }).setView([51.1657, 10.4515], 6);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "Â© OpenStreetMap contributors",
        maxZoom: 19,
      }).addTo(map);

      // Globals
      let markerStart, markerEnd, poiMarker, routeLine;
      let currentDescription = "";
      let currentRouteText = "";

      // Util speech
      function speak(text, lang = "de-DE") {
        if (!("speechSynthesis" in window)) return;
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = lang;
        window.speechSynthesis.speak(u);
      }
      document.getElementById("speakBtn").addEventListener("click", () => {
        if (currentDescription) speak(currentDescription);
      });
      document.getElementById("playRouteBtn").addEventListener("click", () => {
        if (currentRouteText) speak(currentRouteText);
      });

      // Geocode via Nominatim
      async function geocode(query) {
        const url =
          "https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&countrycodes=de&limit=1&q=" +
          encodeURIComponent(query);
        const r = await fetch(url, { headers: { Referer: "file://" } });
        return r.json();
      }

      // Route fetch via OSRM
      async function route(startLat, startLon, endLat, endLon) {
        const url = `https://router.project-osrm.org/route/v1/driving/${startLon},${startLat};${endLon},${endLat}?overview=full&geometries=geojson&steps=true`;
        const r = await fetch(url);
        if (!r.ok) throw new Error("Route fetch failed");
        return r.json();
      }

      // Update POIs for a point
      async function fetchPOIs(lat, lon) {
        const radius = 300;
        const query = `[out:json][timeout:25];(node(around:${radius},${lat},${lon})["name"];way(around:${radius},${lat},${lon})["name"];);out center 15;`;
        const url = "https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(query);
        const list = document.getElementById("poiList");
        list.innerHTML = "<li>Loadingâ€¦</li>";
        try {
          const resp = await fetch(url);
          const data = await resp.json();
          list.innerHTML = "";
          if (data.elements.length === 0) {
            list.innerHTML = "<li>No POIs.</li>";
            return;
          }
          data.elements.forEach((el) => {
            const latPoi = el.lat ?? el.center?.lat;
            const lonPoi = el.lon ?? el.center?.lon;
            if (!latPoi || !lonPoi) return;
            const type =
              el.tags.amenity || el.tags.shop || el.tags.tourism || el.tags.highway || "poi";
            const li = document.createElement("li");
            const btn = document.createElement("button");
            btn.textContent = `${el.tags.name} (${type})`;
            btn.addEventListener("click", () => {
              map.setView([latPoi, lonPoi], 18);
              if (poiMarker) map.removeLayer(poiMarker);
              poiMarker = L.marker([latPoi, lonPoi]).addTo(map);
              lumeVoice.describe(el.tags.name, {
                autoplay: false,
                onResult: (text) => {
                  currentDescription = text;
                  document.getElementById("description").textContent = text;
                  document.getElementById("descBox").style.display = "block";
                  speak(text);
                },
              });
            });
            li.appendChild(btn);
            list.appendChild(li);
          });
        } catch {
          list.innerHTML = "<li>Error fetching POIs.</li>";
        }
      }

      // Handle map click to set start or end if empty
      map.on("click", (e) => {
        const { lat, lng } = e.latlng;
        const startInput = document.getElementById("start");
        const endInput = document.getElementById("end");
        if (!startInput.value) {
          startInput.value = `${lat.toFixed(5)},${lng.toFixed(5)}`;
          if (markerStart) map.removeLayer(markerStart);
          markerStart = L.marker([lat, lng]).addTo(map);
        } else if (!endInput.value) {
          endInput.value = `${lat.toFixed(5)},${lng.toFixed(5)}`;
          if (markerEnd) map.removeLayer(markerEnd);
          markerEnd = L.marker([lat, lng]).addTo(map);
        } else {
          // reset both
          startInput.value = `${lat.toFixed(5)},${lng.toFixed(5)}`;
          if (markerStart) map.removeLayer(markerStart);
          if (markerEnd) map.removeLayer(markerEnd);
          markerStart = L.marker([lat, lng]).addTo(map);
          endInput.value = "";
        }
      });

      // Fetch POIs when map moves
      map.on("moveend", () => {
        const c = map.getCenter();
        fetchPOIs(c.lat, c.lng);
      });

      // Routing button
      document.getElementById("routeBtn").addEventListener("click", async () => {
        const startVal = document.getElementById("start").value.trim();
        const endVal = document.getElementById("end").value.trim();
        if (!startVal || !endVal) {
          alert("Please enter start and destination.");
          return;
        }

        // Obtain coordinates (either lat,lon or address)
        async function toCoords(val) {
          if (/^-?\d+\.\d+,-?\d+\.\d+$/.test(val)) {
            const [lat, lon] = val.split(",").map(parseFloat);
            return { lat, lon };
          }
          const res = await geocode(val);
          if (res.length === 0) throw new Error("Geocode failure");
          return { lat: parseFloat(res[0].lat), lon: parseFloat(res[0].lon) };
        }

        try {
          const s = await toCoords(startVal);
          const t = await toCoords(endVal);

          // markers
          if (markerStart) map.removeLayer(markerStart);
          if (markerEnd) map.removeLayer(markerEnd);
          markerStart = L.marker([s.lat, s.lon]).addTo(map);
          markerEnd = L.marker([t.lat, t.lon]).addTo(map);

          // route fetch
          const data = await route(s.lat, s.lon, t.lat, t.lon);
          const routeGeo = data.routes[0].geometry;
          const steps = data.routes[0].legs[0].steps;

          if (routeLine) map.removeLayer(routeLine);
          routeLine = L.geoJSON(routeGeo, { color: "#0066ff" }).addTo(map);
          map.fitBounds(routeLine.getBounds(), { padding: [30, 30] });

          // list steps
          const ul = document.getElementById("routeSteps");
          ul.innerHTML = "";
          const texts = [];
          steps.forEach((st, idx) => {
            const li = document.createElement("li");
            const text = st.maneuver?.instruction || st.name || "Continue";
            li.textContent = text;
            ul.appendChild(li);
            texts.push(`${idx + 1}. ${text}`);
          });
          currentRouteText = texts.join(". ");
          document.getElementById("routeBox").style.display = "block";
          speak("Route ready. " + texts.slice(0, 3).join(". ")); // teaser
        } catch (err) {
          console.warn(err);
          alert("Routing failed. Please check inputs.");
        }
      });
    </script>

    <!-- Voice helper -->
    <script src="lume-voice.js"></script>
  </body>
</html>