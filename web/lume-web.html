<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LUME â€“ Bike Nav (distance)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin />
  <style>
    :root { --accent:#1abc9c; --bg:#fff; --radius:.75rem; --shadow:0 2px 6px rgba(0,0,0,.15);}  
    html,body{margin:0;height:100%;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:#f5f7f8;}
    #map{height:100%;width:100%;}
    #controls{position:absolute;top:10px;left:10px;z-index:1000;background:var(--bg);padding:.75rem 1rem;border-radius:var(--radius);box-shadow:var(--shadow);display:grid;gap:.4rem;grid-template-columns:1fr 1fr auto auto;width:480px;align-items:center;}
    #info{position:absolute;top:10px;right:10px;z-index:1000;background:var(--bg);padding:.75rem 1rem;border-radius:var(--radius);box-shadow:var(--shadow);width:340px;max-height:90%;overflow:auto;}
    input[type=text]{padding:.35rem .6rem;border:1px solid #ccc;border-radius:var(--radius);font-size:.9rem;}
    button{background:var(--accent);color:#fff;border:none;padding:.45rem .75rem;border-radius:var(--radius);font-size:.9rem;cursor:pointer;transition:opacity .2s;}
    button:disabled{opacity:.4;cursor:not-allowed;}button:hover:not(:disabled){opacity:.85;}
    ul{margin:0;padding-left:1rem;}li{margin-bottom:.3rem;font-size:.85rem;}
    .bikeIcon{font-size:28px;line-height:28px;}
  </style>
</head>
<body>
  <form id="controls" onsubmit="return false;">
    <input id="start" placeholder="Start (addr or lat,lon)" />
    <input id="end" placeholder="Destination (addr or lat,lon)" />
    <button id="routeBtn">Route</button>
    <button id="goBtn" disabled>Go</button>
  </form>

  <aside id="info">
    <h3>Route information</h3>
    <p id="distInfo">Distance: â€“</p>
    <button id="playRouteBtn" aria-label="Speak route">ðŸ”Š</button>
    <ul id="routeSteps"></ul>
  </aside>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
  <script>
    const map=L.map('map',{keyboard:true}).setView([51.1657,10.4515],6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OpenStreetMap contributors',maxZoom:19}).addTo(map);

    const startEl=document.getElementById('start');
    const endEl=document.getElementById('end');
    const routeBtn=document.getElementById('routeBtn');
    const goBtn=document.getElementById('goBtn');
    const stepsUL=document.getElementById('routeSteps');
    const playBtn=document.getElementById('playRouteBtn');
    const distInfo=document.getElementById('distInfo');

    let latlngs=[], totalDist=0; // metres
    let routeSpeech='';

    function speak(t){if(!('speechSynthesis'in window))return;window.speechSynthesis.cancel();const u=new SpeechSynthesisUtterance(t);u.lang='de-DE';window.speechSynthesis.speak(u);}  
    playBtn.onclick=()=>routeSpeech&&speak(routeSpeech);

    async function geocode(q){const url='https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&countrycodes=de&limit=1&q='+encodeURIComponent(q);const r=await fetch(url,{headers:{Referer:'file://'}});return r.json();}
    async function fetchRoute(sl,so,el,eo){const url=`https://router.project-osrm.org/route/v1/cycling/${so},${sl};${eo},${el}?overview=full&geometries=geojson&steps=true`;const r=await fetch(url);if(!r.ok)throw new Error('route');return r.json();}
    const toC=async v=>/^(-?\d+\.\d+),(-?\d+\.\d+)$/.test(v)?{lat:+v.split(',')[0],lon:+v.split(',')[1]}:(await geocode(v))[0]&&{lat:+(await geocode(v))[0].lat,lon:+(await geocode(v))[0].lon};
    const interp=(a,b,t)=>a+(b-a)*t;

    function sumDistance(arr){let d=0;for(let i=0;i<arr.length-1;i++)d+=arr[i].distanceTo(arr[i+1]);return d;}

    async function fetchPOI(lat,lon){const q=`[out:json][timeout:15];(node(around:250,${lat},${lon})["name"];way(around:250,${lat},${lon})["name"];);out center 1;`;try{const r=await fetch('https://overpass-api.de/api/interpreter?data='+encodeURIComponent(q));if(!r.ok)throw'';const d=await r.json();return d.elements[0]?.tags?.name||null}catch{return null}}

    let mStart,mEnd,line,nav;

    routeBtn.onclick=async()=>{
      const sv=startEl.value.trim(),ev=endEl.value.trim();if(!sv||!ev){alert('Enter start & destination');return;}
      try{
        const s=await toC(sv);const e=await toC(ev);
        mStart&&map.removeLayer(mStart);mEnd&&map.removeLayer(mEnd);
        mStart=L.marker([s.lat,s.lon]).addTo(map);
        mEnd=L.marker([e.lat,e.lon]).addTo(map);
        const data=await fetchRoute(s.lat,s.lon,e.lat,e.lon);
        latlngs=data.routes[0].geometry.coordinates.map(c=>L.latLng(c[1],c[0]));
        line&&map.removeLayer(line);line=L.polyline(latlngs,{color:'#FF5722',weight:4}).addTo(map);
        map.fitBounds(line.getBounds(),{padding:[30,30]});
        totalDist=sumDistance(latlngs);distInfo.textContent=`Distance: ${(totalDist/1000).toFixed(1)} km | left: ${(totalDist/1000).toFixed(1)} km`;
        stepsUL.innerHTML='';routeSpeech='';data.routes[0].legs[0].steps.forEach((st,i)=>{const li=document.createElement('li');li.textContent=st.maneuver.instruction||'Continue';stepsUL.appendChild(li);routeSpeech+=`${i+1}. ${li.textContent}. `;});
        goBtn.disabled=false;speak('Route ready. Press Go to start.');
      }catch(e){console.warn(e);alert('Routing failed');}
    };

    goBtn.onclick=()=>{
      if(latlngs.length<2)return;goBtn.disabled=true;nav&&map.removeLayer(nav);
      nav=L.marker(latlngs[0],{icon:L.divIcon({className:'bikeIcon',html:'ðŸš²',iconSize:[28,28]})}).addTo(map);
      speak('Navigation started.');
      const speed=13.9; // m/s 50 km/h
      let segIdx=0,segStart=latlngs[0],segEnd=latlngs[1];
      let segDist=segStart.distanceTo(segEnd),segDur=segDist/speed;let segStartTS=null;
      let travelled=0,lastPOIKm=0,lastDistUpdate=0;

      function raf(ts){
        if(!segStartTS)segStartTS=ts;
        let prog=(ts-segStartTS)/1000/segDur;
        while(prog>=1 && segIdx<latlngs.length-2){
          travelled+=segDist;segIdx++;segStart=latlngs[segIdx];segEnd=latlngs[segIdx+1];segDist=segStart.distanceTo(segEnd);segDur=segDist/speed;segStartTS+=segDur*1000;prog=(ts-segStartTS)/1000/segDur;
        }
        if(segIdx>=latlngs.length-1){nav.setLatLng(latlngs[latlngs.length-1]);map.panTo(latlngs[latlngs.length-1]);speak('You have arrived at your destination.');distInfo.textContent=`Distance: ${(totalDist/1000).toFixed(1)} km | left: 0 km`;goBtn.disabled=false;return;}
        prog=Math.max(0,Math.min(prog,1));
        const lat=interp(segStart.lat,segEnd.lat,prog);const lon=interp(segStart.lng,segEnd.lng,prog);
        nav.setLatLng([lat,lon]);map.panTo([lat,lon],{animate:false});

        const nowDist=travelled+segDist*prog; // meters
        if(ts-lastDistUpdate>5000){lastDistUpdate=ts;const left=totalDist-nowDist;distInfo.textContent=`Distance: ${(totalDist/1000).toFixed(1)} km | left: ${(left/1000).toFixed(1)} km`;}

        const kmBucket=Math.floor(nowDist/10000);
        if(kmBucket>lastPOIKm){lastPOIKm=kmBucket;fetchPOI(lat,lon).then(name=>{if(name)speak(`In der NÃ¤he: ${name}`);});}
        requestAnimationFrame(raf);
      }
      requestAnimationFrame(raf);
    };
  </script>
  <script src="lume-voice.js"></script>
</body>
</html>
